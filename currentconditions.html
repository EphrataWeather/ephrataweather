<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ephrata, PA Weather</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
        }
        .card {
            background-color: #1e293b;
            color: #e2e8f0;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #334155;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .data-label {
            font-weight: 600;
            color: #94a3b8;
        }
        .data-value {
            font-weight: 700;
            color: #f1f5f9;
        }
        .forecast-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.75rem;
            background-color: #334155;
            text-align: center;
        }
        .weather-icon {
            font-size: 2.5rem;
            line-height: 1;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="weather-container" class="w-full max-w-lg">
        <!-- Main Weather Card -->
        <div class="card text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold mb-2">Ephrata, PA</h1>
            <p class="text-lg sm:text-xl text-gray-400 mb-6" id="last-updated"></p>
            
            <div id="loading" class="text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-gray-600 mx-auto"></div>
                <p class="mt-4 text-gray-400">Loading weather data...</p>
            </div>

            <div id="weather-data" class="hidden">
                <div class="text-5xl sm:text-6xl font-extrabold text-blue-400 mb-2" id="temperature">--°F</div>
                <div class="text-base sm:text-lg text-gray-400 mb-6" id="feels-like">Feels like --°F</div>
                
                <!-- Data grid stacks on mobile, becomes 2 columns on medium screens -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-left">
                    <div class="data-item">
                        <span class="data-label">Wind</span>
                        <span class="data-value" id="wind">-- mph</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Humidity</span>
                        <span class="data-value" id="humidity">--%</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Pressure</span>
                        <span class="data-value" id="pressure">-- mb</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Dew Point</span>
                        <span class="data-value" id="dew-point">--°F</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hourly Forecast Card -->
        <div class="card">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-center">Hourly Forecast</h2>
            <div id="hourly-forecast-container">
                <p id="forecast-message" class="text-center text-gray-400">Checking for hourly forecast...</p>
                <!-- Forecast grid is 2 columns on mobile, 3 columns on larger screens -->
                <div id="forecast-grid" class="mt-4 hidden grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const STATION_ID = 168579;
            const TOKEN = '7924050f-deed-4373-9755-fb0c8c8668b9';
            const WEATHER_API_URL = `https://swd.weatherflow.com/swd/rest/better_forecast?station_id=${STATION_ID}&token=${TOKEN}`;

            const weatherDataEl = document.getElementById('weather-data');
            const loadingEl = document.getElementById('loading');
            const lastUpdatedEl = document.getElementById('last-updated');
            const temperatureEl = document.getElementById('temperature');
            const feelsLikeEl = document.getElementById('feels-like');
            const windEl = document.getElementById('wind');
            const humidityEl = document.getElementById('humidity');
            const pressureEl = document.getElementById('pressure');
            const dewPointEl = document.getElementById('dew-point');
            const forecastMessageEl = document.getElementById('forecast-message');
            const forecastGridEl = document.getElementById('forecast-grid');

            // Function to calculate dew point in Fahrenheit
            const calculateDewPoint = (tempC, rh) => {
                const a = 17.27;
                const b = 237.7;
                const tempPart = (a * tempC) / (b + tempC);
                const dewPointC = (b * (tempPart + Math.log(rh / 100))) / (a - (tempPart + Math.log(rh / 100)));
                return (dewPointC * 9 / 5) + 32; // Convert to Fahrenheit
            };

            // Function to format wind direction
            const getWindDirection = (degrees) => {
                const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
                const index = Math.round((degrees % 360) / 22.5);
                return directions[index % 16];
            };

            // Function to get a weather icon based on condition string
            const getWeatherIcon = (condition) => {
                condition = condition.toLowerCase();
                if (condition.includes('thunderstorm')) {
                    return '⛈️';
                } else if (condition.includes('rain') || condition.includes('showers')) {
                    return '🌧️';
                } else if (condition.includes('cloudy')) {
                    return '☁️';
                } else if (condition.includes('clear')) {
                    return '☀️';
                } else if (condition.includes('snow')) {
                    return '❄️';
                } else if (condition.includes('fog')) {
                    return '🌫️';
                }
                return '❓'; // Default icon for unknown conditions
            };

            const fetchData = async () => {
                try {
                    const response = await fetch(WEATHER_API_URL);
                    const data = await response.json();

                    if (data.status.status_code !== 0) {
                        throw new Error(data.status.status_message);
                    }

                    // Extract and display current conditions
                    const current = data.current_conditions;
                    if (current) {
                        const tempF = (current.air_temperature * 9 / 5) + 32;
                        const feelsLikeF = (current.feels_like * 9 / 5) + 32;
                        const windSpeed = current.wind_avg * 2.23694; // m/s to mph
                        const windDir = getWindDirection(current.wind_direction);
                        const pressureMb = current.sea_level_pressure; // Already in millibars (hPa)
                        const dewPointF = calculateDewPoint(current.air_temperature, current.relative_humidity);

                        temperatureEl.textContent = `${Math.round(tempF)}°F`;
                        feelsLikeEl.textContent = `Feels like ${Math.round(feelsLikeF)}°F`;
                        windEl.textContent = `${Math.round(windSpeed)} mph ${windDir}`;
                        humidityEl.textContent = `${current.relative_humidity}%`;
                        pressureEl.textContent = `${Math.round(pressureMb)} mb`;
                        dewPointEl.textContent = `${Math.round(dewPointF)}°F`;
                        
                        if (current.timestamp) {
                           const lastUpdated = new Date(current.timestamp * 1000);
                           lastUpdatedEl.textContent = `Last updated: ${lastUpdated.toLocaleTimeString()}`;
                        }

                        weatherDataEl.classList.remove('hidden');
                        loadingEl.classList.add('hidden');
                    }

                    // Display hourly forecast
                    const hourlyForecast = data.forecast?.hourly;
                    if (hourlyForecast && hourlyForecast.length > 0) {
                        forecastMessageEl.textContent = 'Here is the hourly forecast:';
                        forecastGridEl.innerHTML = '';
                        hourlyForecast.slice(0, 6).forEach(forecast => { // Displaying the next 6 hours
                            const time = new Date(forecast.time * 1000).toLocaleTimeString([], {hour: 'numeric'});
                            const tempF = Math.round((forecast.air_temperature * 9 / 5) + 32);
                            const icon = getWeatherIcon(forecast.conditions);
                            const precipProb = Math.round(forecast.precip_prob || 0);

                            const div = document.createElement('div');
                            div.className = 'forecast-item';
                            div.innerHTML = `
                                <div class="font-semibold text-gray-400">${time}</div>
                                <div class="weather-icon">${icon}</div>
                                <div class="text-2xl font-bold text-gray-200">${tempF}°F</div>
                            `;
                            forecastGridEl.appendChild(div);
                        });
                        forecastGridEl.classList.remove('hidden');
                    } else {
                        forecastMessageEl.textContent = 'Hourly forecast is not available.';
                        forecastGridEl.classList.add('hidden');
                    }

                } catch (error) {
                    loadingEl.innerHTML = `<p class="text-red-400 mt-4">Failed to load weather data. Please check the API token or station ID. Error: ${error.message}</p>`;
                    console.error("Error fetching weather data:", error);
                }
            };

            fetchData();
            // Refresh data every 5 minutes
            setInterval(fetchData, 300000); 
        });
    </script>

</body>
</html>
