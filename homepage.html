<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ephrata Weather Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .section-container {
            background-color: #1e293b;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #radar-section #map {
            min-height: 50vh;
        }
        #alerts-section .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom styles for the weather dashboard card */
        .card {
            background-color: #1e293b;
            color: #e2e8f0;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #334155;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .data-label {
            font-weight: 600;
            color: #94a3b8;
        }
        .data-value {
            font-weight: 700;
            color: #f1f5f9;
        }
        .forecast-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.75rem;
            background-color: #334155;
            text-align: center;
        }
        .weather-icon {
            font-size: 2.5rem;
            line-height: 1;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center py-8 sm:py-12">
            <h1 class="text-4xl sm:text-5xl font-bold text-white">Ephrata Weather Hub</h1>
            <p class="text-xl sm:text-2xl mt-2 text-slate-400">Your one-stop source for local weather.</p>
        </header>

        <section id="current-conditions-section" class="section-container">
            <!-- Main Weather Card -->
            <div class="card text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold mb-2">Ephrata, PA</h1>
                <p class="text-lg sm:text-xl text-gray-400 mb-6" id="last-updated"></p>
                
                <div id="loading" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-gray-600 mx-auto"></div>
                    <p class="mt-4 text-gray-400">Loading weather data...</p>
                </div>

                <div id="weather-data" class="hidden">
                    <div class="text-5xl sm:text-6xl font-extrabold text-blue-400 mb-2" id="temperature">--°F</div>
                    <div class="text-base sm:text-lg text-gray-400 mb-6" id="feels-like">Feels like --°F</div>
                    
                    <!-- Data grid stacks on mobile, becomes 2 columns on medium screens -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-left">
                        <div class="data-item">
                            <span class="data-label">Wind</span>
                            <span class="data-value" id="wind">-- mph</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Humidity</span>
                            <span class="data-value" id="humidity">--%</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Pressure</span>
                            <span class="data-value" id="pressure">-- mb</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Dew Point</span>
                            <span class="data-value" id="dew-point">--°F</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hourly Forecast Card -->
            <div class="card mb-8">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-center">Hourly Forecast</h2>
                <div id="hourly-forecast-container">
                    <p id="forecast-message" class="text-center text-gray-400">Checking for hourly forecast...</p>
                    <!-- Forecast grid is 2 columns on mobile, 3 columns on larger screens -->
                    <div id="forecast-grid" class="mt-4 hidden grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                </div>
            </div>
            
            <!-- Weather Alerts Card -->
            <div class="card">
                <h2 class="text-xl sm:text-2xl font-bold text-white mb-6 text-center">Weather Alerts</h2>
                <div id="loading-alerts" class="text-center p-8">
                    <div class="animate-pulse text-slate-400">
                        <svg class="w-16 h-16 mx-auto text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 4m0 5c-.5 1.5-1 3-1.5 4.5"/></svg>
                        <p class="mt-4 text-xl">Checking for alerts...</p>
                    </div>
                </div>
                <div id="alerts-container" class="hidden space-y-6">
                </div>
            </div>
        </section>

        <section id="radar-section" class="section-container">
            <h2 class="text-2xl sm:text-3xl font-bold text-white mb-6 text-center">National Composite Radar</h2>
            <div id="map" class="rounded-xl shadow-md overflow-hidden"></div>
            <div class="control-panel mt-6">
                <div class="controls-row flex items-center gap-4">
                    <button id="play" class="bg-cyan-500 text-slate-900 font-bold py-3 px-6 rounded-full shadow-lg transition transform hover:scale-105">▶ Play</button>
                    <div class="flex-grow flex flex-col gap-1">
                        <input id="frame" type="range" min="0" max="0" value="0" step="1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        <span id="timestamp" class="text-sm text-slate-400 text-right">Loading...</span>
                    </div>
                </div>
                <div class="controls-row flex items-center gap-4 mt-4">
                    <label for="opacity" class="text-sm font-medium text-slate-400">Opacity</label>
                    <input id="opacity" type="range" min="0" max="1" value="0.8" step="0.05" class="flex-grow h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="color-scale flex justify-center gap-2 mt-4">
                    <div class="w-6 h-6 rounded-md bg-[#00ffff]" title="Light Rain"></div>
                    <div class="w-6 h-6 rounded-md bg-[#0000ff]" title="Moderate Rain"></div>
                    <div class="w-6 h-6 rounded-md bg-[#00ff00]" title="Heavy Rain"></div>
                    <div class="w-6 h-6 rounded-md bg-[#ffff00]" title="Very Heavy Rain"></div>
                    <div class="w-6 h-6 rounded-md bg-[#ff0000]" title="Intense Rain"></div>
                    <div class="w-6 h-6 rounded-md bg-[#ff00ff]" title="Extreme Rain/Hail"></div>
                </div>
                <div class="legend text-xs text-slate-500 text-center mt-4">
                    Tiles: <a href="https://www.rainviewer.com/api.html" target="_blank" rel="noopener" class="text-cyan-400 hover:underline">RainViewer</a> · Map: © <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener" class="text-cyan-400 hover:underline">OSM</a>
                </div>
            </div>
        </section>

        <footer class="text-center text-slate-500 text-sm mt-8 pb-4">
            <p>&copy; 2025 Ephrata Weather Hub. All rights reserved.</p>
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // --- All Weather Data Scripts ---
        document.addEventListener('DOMContentLoaded', () => {
            const STATION_ID = 168579;
            const TOKEN = '7924050f-deed-4373-9755-fb0c8c8668b9';
            const WEATHER_API_URL = `https://swd.weatherflow.com/swd/rest/better_forecast?station_id=${STATION_ID}&token=${TOKEN}`;
            const NWS_API_URL = "https://api.weather.gov";
            const ZONE_ID = "PAZ066";

            const weatherDataEl = document.getElementById('weather-data');
            const loadingEl = document.getElementById('loading');
            const lastUpdatedEl = document.getElementById('last-updated');
            const temperatureEl = document.getElementById('temperature');
            const feelsLikeEl = document.getElementById('feels-like');
            const windEl = document.getElementById('wind');
            const humidityEl = document.getElementById('humidity');
            const pressureEl = document.getElementById('pressure');
            const dewPointEl = document.getElementById('dew-point');
            
            const forecastMessageEl = document.getElementById('forecast-message');
            const forecastGridEl = document.getElementById('forecast-grid');

            const alertsContainer = document.getElementById('alerts-container');
            const loadingAlertsElement = document.getElementById('loading-alerts');

            // Function to calculate dew point in Fahrenheit
            const calculateDewPoint = (tempC, rh) => {
                const a = 17.27;
                const b = 237.7;
                const tempPart = (a * tempC) / (b + tempC);
                const dewPointC = (b * (tempPart + Math.log(rh / 100))) / (a - (tempPart + Math.log(rh / 100)));
                return (dewPointC * 9 / 5) + 32; // Convert to Fahrenheit
            };

            // Function to format wind direction
            const getWindDirection = (degrees) => {
                const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
                const index = Math.round((degrees % 360) / 22.5);
                return directions[index % 16];
            };

            // Function to get a weather icon based on condition string
            const getWeatherIcon = (condition) => {
                condition = condition.toLowerCase();
                if (condition.includes('thunderstorm')) {
                    return '⛈️';
                } else if (condition.includes('rain') || condition.includes('showers')) {
                    return '🌧️';
                } else if (condition.includes('cloudy')) {
                    return '☁️';
                } else if (condition.includes('clear')) {
                    return '☀️';
                } else if (condition.includes('snow')) {
                    return '❄️';
                } else if (condition.includes('fog')) {
                    return '🌫️';
                }
                return '❓'; // Default icon for unknown conditions
            };

            // Fetch WeatherFlow data for current and hourly
            const fetchWeatherData = async () => {
                try {
                    const response = await fetch(WEATHER_API_URL);
                    const data = await response.json();

                    if (data.status.status_code !== 0) {
                        throw new Error(data.status.status_message);
                    }

                    // Extract and display current conditions
                    const current = data.current_conditions;
                    if (current) {
                        const tempF = (current.air_temperature * 9 / 5) + 32;
                        const feelsLikeF = (current.feels_like * 9 / 5) + 32;
                        const windSpeed = current.wind_avg * 2.23694; // m/s to mph
                        const windDir = getWindDirection(current.wind_direction);
                        const pressureMb = current.sea_level_pressure; // Already in millibars (hPa)
                        const dewPointF = calculateDewPoint(current.air_temperature, current.relative_humidity);

                        temperatureEl.textContent = `${Math.round(tempF)}°F`;
                        feelsLikeEl.textContent = `Feels like ${Math.round(feelsLikeF)}°F`;
                        windEl.textContent = `${Math.round(windSpeed)} mph ${windDir}`;
                        humidityEl.textContent = `${current.relative_humidity}%`;
                        pressureEl.textContent = `${Math.round(pressureMb)} mb`;
                        dewPointEl.textContent = `${Math.round(dewPointF)}°F`;
                        
                        if (current.timestamp) {
                           const lastUpdated = new Date(current.timestamp * 1000);
                           lastUpdatedEl.textContent = `Last updated: ${lastUpdated.toLocaleTimeString()}`;
                        }

                        weatherDataEl.classList.remove('hidden');
                        loadingEl.classList.add('hidden');
                    }

                    // Display hourly forecast
                    const hourlyForecast = data.forecast?.hourly;
                    if (hourlyForecast && hourlyForecast.length > 0) {
                        forecastMessageEl.textContent = 'Here is the hourly forecast:';
                        forecastGridEl.innerHTML = '';
                        hourlyForecast.slice(0, 6).forEach(forecast => { // Displaying the next 6 hours
                            const time = new Date(forecast.time * 1000).toLocaleTimeString([], {hour: 'numeric'});
                            const tempF = Math.round((forecast.air_temperature * 9 / 5) + 32);
                            const icon = getWeatherIcon(forecast.conditions);
                            const precipProb = Math.round(forecast.precip_prob || 0);

                            const div = document.createElement('div');
                            div.className = 'forecast-item';
                            div.innerHTML = `
                                <div class="font-semibold text-gray-400">${time}</div>
                                <div class="weather-icon">${icon}</div>
                                <div class="text-2xl font-bold text-gray-200">${tempF}°F</div>
                            `;
                            forecastGridEl.appendChild(div);
                        });
                        forecastGridEl.classList.remove('hidden');
                    } else {
                        forecastMessageEl.textContent = 'Hourly forecast is not available.';
                        forecastGridEl.classList.add('hidden');
                    }

                } catch (error) {
                    loadingEl.innerHTML = `<p class="text-red-400 mt-4">Failed to load weather data. Please check the API token or station ID. Error: ${error.message}</p>`;
                    console.error("Error fetching weather data:", error);
                }
            };
            
            // Fetch NWS alerts
            function getSeverityIcon(severity) {
                switch(severity.toLowerCase()) {
                    case 'minor': return `<svg class="w-6 h-6 flex-shrink-0 text-yellow-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`;
                    case 'moderate': return `<svg class="w-6 h-6 flex-shrink-0 text-orange-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>`;
                    case 'severe': case 'extreme': return `<svg class="w-6 h-6 flex-shrink-0 text-red-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
                    default: return `<svg class="w-6 h-6 flex-shrink-0 text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
                }
            }
            function getSeverityColor(severity) {
                switch(severity.toLowerCase()) {
                    case 'minor': return 'bg-yellow-950 border-yellow-700 text-yellow-200';
                    case 'moderate': return 'bg-orange-950 border-orange-700 text-orange-200';
                    case 'severe': return 'bg-red-950 border-red-700 text-red-200';
                    case 'extreme': return 'bg-red-700 border-red-800 text-white';
                    default: return 'bg-blue-950 border-blue-700 text-blue-200';
                }
            }
            async function fetchWeatherAlerts() {
                loadingAlertsElement.classList.remove('hidden');
                alertsContainer.classList.add('hidden');
                alertsContainer.innerHTML = '';
                try {
                    const response = await fetch(`${NWS_API_URL}/alerts/active?zone=${ZONE_ID}`, { headers: { 'User-Agent': 'EphrataWeatherHub, (myemail@example.com)' } });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (data.features.length === 0) {
                        alertsContainer.innerHTML = `<div class="text-center p-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700 fade-in"><p class="text-lg font-medium text-slate-400">No active weather alerts for Ephrata, PA.</p></div>`;
                    } else {
                        data.features.forEach(alert => {
                            const props = alert.properties;
                            const severityClass = getSeverityColor(props.severity);
                            const severityIcon = getSeverityIcon(props.severity);
                            const alertCard = `<div class="flex items-start gap-4 p-5 rounded-2xl shadow-lg border ${severityClass} fade-in">
                                    <div class="flex-shrink-0 mt-1">${severityIcon}</div>
                                    <div><h3 class="text-lg font-bold">${props.event}</h3>
                                        <p class="text-sm font-semibold opacity-75 mt-1">Severity: ${props.severity}</p>
                                        <p class="text-sm mt-2">${props.headline}</p>
                                        <a href="${props.url}" target="_blank" class="mt-3 inline-block font-semibold hover:underline text-sm text-cyan-400">Read more</a>
                                    </div>
                                </div>`;
                            alertsContainer.innerHTML += alertCard;
                        });
                    }
                } catch (error) {
                    console.error("Failed to fetch weather alerts:", error);
                    alertsContainer.innerHTML = `<div class="text-center p-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700 fade-in"><h3 class="text-xl font-bold text-red-500">Error</h3><p class="mt-2 text-slate-400">Failed to load weather alerts.</p></div>`;
                } finally {
                    loadingAlertsElement.classList.add('hidden');
                    alertsContainer.classList.remove('hidden');
                }
            }

            // Run both fetches
            fetchWeatherData();
            fetchWeatherAlerts();
            // Refresh data every 5 minutes
            setInterval(() => {
                fetchWeatherData();
                fetchWeatherAlerts();
            }, 300000); 
        });

        // --- National Composite Radar Script (from national_composite_radar_viewer.html) ---
        const map = L.map('map', { zoomControl: true, minZoom: 2, worldCopyJump: true });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
        map.setView([40.1797, -76.1786], 9);
        const radarLayer = L.tileLayer('', { opacity: 0.8, attribution: 'Radar tiles © RainViewer' }).addTo(map);

        const playBtn = document.getElementById('play');
        const frameSlider = document.getElementById('frame');
        const tsEl = document.getElementById('timestamp');
        const opacitySlider = document.getElementById('opacity');

        let frames = [];
        let host = 'https://tilecache.rainviewer.com';
        let idx = 0;
        let timer = null;

        function fmtUTC(epoch) {
            const d = new Date(epoch * 1000);
            return d.toLocaleString(undefined, { hour12: true, year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        }
        function radarUrl(frame) { return `${host}/v2/radar/${frame.path}/256/{z}/{x}/{y}/2/1_1.png`; }
        function updateFrame(newIndex) {
            if (!frames.length) return;
            idx = (newIndex + frames.length) % frames.length;
            const f = frames[idx];
            radarLayer.setUrl(radarUrl(f));
            frameSlider.value = idx;
            tsEl.textContent = `Valid: ${fmtUTC(f.time)}`;
        }
        function setPlaying(yes) {
            if (yes) {
                playBtn.textContent = '⏸ Pause';
                if (timer) clearInterval(timer);
                timer = setInterval(() => updateFrame(idx + 1), 650);
            } else {
                playBtn.textContent = '▶ Play';
                if (timer) { clearInterval(timer); timer = null; }
            }
        }
        playBtn.addEventListener('click', () => setPlaying(!timer));
        frameSlider.addEventListener('input', (e) => { setPlaying(false); updateFrame(parseInt(e.target.value, 10)); });
        opacitySlider.addEventListener('input', (e) => radarLayer.setOpacity(parseFloat(e.target.value)));

        async function loadFrames() {
            tsEl.textContent = 'Loading frames…';
            try {
                const resp = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                const json = await resp.json();
                host = json.host || host;
                const past = (json.radar && Array.isArray(json.radar.past)) ? json.radar.past : [];
                if (!past.length) throw new Error('No radar frames available.');
                frames = past.slice(-10);
                frameSlider.max = String(frames.length - 1);
                frameSlider.value = String(frames.length - 1);
                updateFrame(frames.length - 1);
                setPlaying(false);
            } catch (err) {
                console.error(err);
                tsEl.textContent = 'Failed to load radar frames';
            }
        }
        document.addEventListener('DOMContentLoaded', loadFrames);
    </script>
</body>
</html>
